import{nanoid as e}from"nanoid";import{TezosOperationError as t,TezosToolkit as s,createTransferOperation as n,createOriginationOperation as r,createSetDelegateOperation as a}from"@taquito/taquito";var i,o,c;function m(){return new Promise(e=>{const t=e=>{var t,n;e.source===window&&(null===(t=e.data)||void 0===t?void 0:t.type)===c.Response&&"PONG"===(null===(n=e.data)||void 0===n?void 0:n.payload)&&s(!0)},s=s=>{e(s),window.removeEventListener("message",t),clearTimeout(n)};y({type:c.Request,payload:"PING"}),window.addEventListener("message",t);const n=setTimeout(()=>s(!1),500)})}function u(e){let t,s=!1;const n=async(r=0)=>{const a=r<5,i=await m();s!==i&&(e(i),s=i),t=setTimeout(n,i?1e4:a?0:5e3,a?r+1:r)};return n(),()=>clearTimeout(t)}function p(e){let t,s=null;const n=async()=>{try{const t=await l();a=s,(null===(r=t)?null===a:r.pkh===(null==a?void 0:a.pkh)&&r.rpc===(null==a?void 0:a.rpc))||(e(t),s=t)}catch{}var r,a;t=setTimeout(n,1e4)};return n(),()=>clearTimeout(t)}async function l(){const e=await h({type:i.GetCurrentPermissionRequest});return g(e.type===i.GetCurrentPermissionResponse),e.permission}async function d(e,t,s){const n=await h({type:i.PermissionRequest,network:e,appMeta:t,force:s});return g(n.type===i.PermissionResponse),{rpc:n.rpc,pkh:n.pkh,publicKey:n.publicKey}}async function E(e,t){const s=await h({type:i.OperationRequest,sourcePkh:e,opParams:t});return g(s.type===i.OperationResponse),s.opHash}async function P(e,t){const s=await h({type:i.SignRequest,sourcePkh:e,payload:t});return g(s.type===i.SignResponse),s.signature}async function R(e){const t=await h({type:i.BroadcastRequest,signedOpBytes:e});return g(t.type===i.BroadcastResponse),t.opHash}function h(s){return new Promise((n,r)=>{const a=e(),i=e=>{const s=e.data;switch(!0){case e.source!==window||(null==s?void 0:s.reqId)!==a:return;case(null==s?void 0:s.type)===c.Response:n(s.payload),window.removeEventListener("message",i);break;case(null==s?void 0:s.type)===c.ErrorResponse:r(function(e){switch(!0){case e===o.NotGranted:return new f;case e===o.NotFound:return new S;case e===o.InvalidParams:return new T;case Array.isArray(e)&&e[0]===o.TezosOperation&&Array.isArray(e[1])&&e[1].length>0:return new t(e[1]);case"string"==typeof e&&e.startsWith("__tezos__"):return new Error(e.replace("__tezos__",""));default:return new w}}(s.payload)),window.removeEventListener("message",i)}};y({type:c.Request,payload:s,reqId:a}),window.addEventListener("message",i)})}function g(e){if(!e)throw new Error("Invalid response recieved")}function y(e){window.postMessage(e,"*")}!function(e){e.GetCurrentPermissionRequest="GET_CURRENT_PERMISSION_REQUEST",e.GetCurrentPermissionResponse="GET_CURRENT_PERMISSION_RESPONSE",e.PermissionRequest="PERMISSION_REQUEST",e.PermissionResponse="PERMISSION_RESPONSE",e.OperationRequest="OPERATION_REQUEST",e.OperationResponse="OPERATION_RESPONSE",e.SignRequest="SIGN_REQUEST",e.SignResponse="SIGN_RESPONSE",e.BroadcastRequest="BROADCAST_REQUEST",e.BroadcastResponse="BROADCAST_RESPONSE"}(i||(i={})),function(e){e.NotGranted="NOT_GRANTED",e.NotFound="NOT_FOUND",e.InvalidParams="INVALID_PARAMS",e.TezosOperation="TEZOS_OPERATION"}(o||(o={})),function(e){e.Request="TEMPLE_PAGE_REQUEST",e.Response="TEMPLE_PAGE_RESPONSE",e.ErrorResponse="TEMPLE_PAGE_ERROR_RESPONSE"}(c||(c={}));class w{constructor(){this.name="TempleWalletError",this.message="An unknown error occured. Please try again or report it"}}class f extends w{constructor(){super(...arguments),this.name="NotGrantedTempleWalletError",this.message="Permission Not Granted"}}class S extends w{constructor(){super(...arguments),this.name="NotFoundTempleWalletError",this.message="Account Not Found. Try connect again"}}class T extends w{constructor(){super(...arguments),this.name="InvalidParamsTempleWalletError",this.message="Some of the parameters you provided are invalid"}}class _{constructor(e,t){this.appName=e,this.permission=null,t&&(this.permission=t)}get connected(){return Boolean(this.permission)}toTezos(){v(this.permission);const e=new s(this.permission.rpc);return e.setProvider({wallet:this}),e}async connect(e,t={forcePermission:!1}){const s=await d(e,{name:this.appName},t.forcePermission);this.permission=s}reconnect(e){return this.connect(e,{forcePermission:!0})}async getPKH(){return v(this.permission),this.permission.pkh}async mapTransferParamsToWalletParams(e){const t=await e();return this.removeDefaultParams(t,await n(this.formatParameters(t)))}async mapOriginateParamsToWalletParams(e){const t=await e();return this.removeDefaultParams(t,await r(this.formatParameters(t)))}async mapDelegateParamsToWalletParams(e){const t=await e();return this.removeDefaultParams(t,await a(this.formatParameters(t)))}async sendOperations(e){return v(this.permission),E(this.permission.pkh,e.map(O))}async sign(e){return v(this.permission),P(this.permission.pkh,e)}async broadcast(e){return v(this.permission),R(e)}formatParameters(e){return e.fee&&(e.fee=e.fee.toString()),e.storageLimit&&(e.storageLimit=e.storageLimit.toString()),e.gasLimit&&(e.gasLimit=e.gasLimit.toString()),e}removeDefaultParams(e,t){return e.fee||delete t.fee,e.storageLimit||delete t.storage_limit,e.gasLimit||delete t.gas_limit,t}}_.isAvailable=m,_.onAvailabilityChange=u,_.getCurrentPermission=l,_.onPermissionChange=p;class N extends w{constructor(){super(...arguments),this.name="TempleWalletNotConnected",this.message="You need to connect TempleWallet by calling templeWallet.connect() first"}}function v(e){if(!e)throw new N}function O(e){const{fee:t,gas_limit:s,storage_limit:n,...r}=e;switch(e.kind){case"origination":return{...r,mutez:!0,fee:t,gasLimit:s,storageLimit:n};case"transaction":const{destination:e,amount:a,parameters:i,...o}=r;return{...o,to:e,amount:+a,mutez:!0,parameter:i,fee:t,gasLimit:s,storageLimit:n};default:return{...r,fee:t,gasLimit:s,storageLimit:n}}}export{T as InvalidParamsTempleWalletError,N as NotConnectedTempleWalletError,S as NotFoundTempleWalletError,f as NotGrantedTempleWalletError,o as TempleDAppErrorType,i as TempleDAppMessageType,c as TemplePageMessageType,_ as TempleWallet,w as TempleWalletError,l as getCurrentPermission,m as isAvailable,u as onAvailabilityChange,p as onPermissionChange,R as requestBroadcast,E as requestOperation,d as requestPermission,P as requestSign};
//# sourceMappingURL=index.modern.js.map
