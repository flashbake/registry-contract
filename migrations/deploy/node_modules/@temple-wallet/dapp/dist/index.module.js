import{nanoid as e}from"nanoid";import{TezosOperationError as r,TezosToolkit as t,createTransferOperation as n,createOriginationOperation as o,createSetDelegateOperation as i}from"@taquito/taquito";var s,a,u;function c(){return(c=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e}).apply(this,arguments)}function m(e,r){e.prototype=Object.create(r.prototype),e.prototype.constructor=e,e.__proto__=r}function l(e,r){if(null==e)return{};var t,n,o={},i=Object.keys(e);for(n=0;n<i.length;n++)r.indexOf(t=i[n])>=0||(o[t]=e[t]);return o}!function(e){e.GetCurrentPermissionRequest="GET_CURRENT_PERMISSION_REQUEST",e.GetCurrentPermissionResponse="GET_CURRENT_PERMISSION_RESPONSE",e.PermissionRequest="PERMISSION_REQUEST",e.PermissionResponse="PERMISSION_RESPONSE",e.OperationRequest="OPERATION_REQUEST",e.OperationResponse="OPERATION_RESPONSE",e.SignRequest="SIGN_REQUEST",e.SignResponse="SIGN_RESPONSE",e.BroadcastRequest="BROADCAST_REQUEST",e.BroadcastResponse="BROADCAST_RESPONSE"}(s||(s={})),function(e){e.NotGranted="NOT_GRANTED",e.NotFound="NOT_FOUND",e.InvalidParams="INVALID_PARAMS",e.TezosOperation="TEZOS_OPERATION"}(a||(a={})),function(e){e.Request="TEMPLE_PAGE_REQUEST",e.Response="TEMPLE_PAGE_RESPONSE",e.ErrorResponse="TEMPLE_PAGE_ERROR_RESPONSE"}(u||(u={}));var p=function(e){try{return Promise.resolve(g({type:s.BroadcastRequest,signedOpBytes:e})).then(function(e){return R(e.type===s.BroadcastResponse),e.opHash})}catch(e){return Promise.reject(e)}},f=function(e,r){try{return Promise.resolve(g({type:s.SignRequest,sourcePkh:e,payload:r})).then(function(e){return R(e.type===s.SignResponse),e.signature})}catch(e){return Promise.reject(e)}},P=function(e,r){try{return Promise.resolve(g({type:s.OperationRequest,sourcePkh:e,opParams:r})).then(function(e){return R(e.type===s.OperationResponse),e.opHash})}catch(e){return Promise.reject(e)}},v=function(e,r,t){try{return Promise.resolve(g({type:s.PermissionRequest,network:e,appMeta:r,force:t})).then(function(e){return R(e.type===s.PermissionResponse),{rpc:e.rpc,pkh:e.pkh,publicKey:e.publicKey}})}catch(e){return Promise.reject(e)}},h=function(){try{return Promise.resolve(g({type:s.GetCurrentPermissionRequest})).then(function(e){return R(e.type===s.GetCurrentPermissionResponse),e.permission})}catch(e){return Promise.reject(e)}};function d(){return new Promise(function(e){var r=function(e){var r,n;e.source===window&&(null===(r=e.data)||void 0===r?void 0:r.type)===u.Response&&"PONG"===(null===(n=e.data)||void 0===n?void 0:n.payload)&&t(!0)},t=function(t){e(t),window.removeEventListener("message",r),clearTimeout(n)};_({type:u.Request,payload:"PING"}),window.addEventListener("message",r);var n=setTimeout(function(){return t(!1)},500)})}function y(e){var r,t=!1;return function n(o){void 0===o&&(o=0);try{var i=o<5;return Promise.resolve(d()).then(function(s){t!==s&&(e(s),t=s),r=setTimeout(n,s?1e4:i?0:5e3,i?o+1:o)})}catch(e){return Promise.reject(e)}}(),function(){return clearTimeout(r)}}function E(e){var r,t=null;return function n(){try{var o=function(){r=setTimeout(n,1e4)},i=function(r,n){try{var o=Promise.resolve(h()).then(function(r){var n,o;o=t,(null===(n=r)?null===o:n.pkh===(null==o?void 0:o.pkh)&&n.rpc===(null==o?void 0:o.rpc))||(e(r),t=r)})}catch(e){return}return o&&o.then?o.then(void 0,function(){}):o}();return Promise.resolve(i&&i.then?i.then(o):o())}catch(e){return Promise.reject(e)}}(),function(){return clearTimeout(r)}}function g(t){return new Promise(function(n,o){var i=e();_({type:u.Request,payload:t,reqId:i}),window.addEventListener("message",function e(t){var s=t.data;switch(!0){case t.source!==window||(null==s?void 0:s.reqId)!==i:return;case(null==s?void 0:s.type)===u.Response:n(s.payload),window.removeEventListener("message",e);break;case(null==s?void 0:s.type)===u.ErrorResponse:o(function(e){switch(!0){case e===a.NotGranted:return new T;case e===a.NotFound:return new O;case e===a.InvalidParams:return new w;case Array.isArray(e)&&e[0]===a.TezosOperation&&Array.isArray(e[1])&&e[1].length>0:return new r(e[1]);case"string"==typeof e&&e.startsWith("__tezos__"):return new Error(e.replace("__tezos__",""));default:return new S}}(s.payload)),window.removeEventListener("message",e)}})})}function R(e){if(!e)throw new Error("Invalid response recieved")}function _(e){window.postMessage(e,"*")}var S=function(){this.name="TempleWalletError",this.message="An unknown error occured. Please try again or report it"},T=function(e){function r(){var r;return(r=e.apply(this,arguments)||this).name="NotGrantedTempleWalletError",r.message="Permission Not Granted",r}return m(r,e),r}(S),O=function(e){function r(){var r;return(r=e.apply(this,arguments)||this).name="NotFoundTempleWalletError",r.message="Account Not Found. Try connect again",r}return m(r,e),r}(S),w=function(e){function r(){var r;return(r=e.apply(this,arguments)||this).name="InvalidParamsTempleWalletError",r.message="Some of the parameters you provided are invalid",r}return m(r,e),r}(S),N=function(){function e(e,r){this.appName=e,this.permission=null,r&&(this.permission=r)}var r,s=e.prototype;return s.toTezos=function(){A(this.permission);var e=new t(this.permission.rpc);return e.setProvider({wallet:this}),e},s.connect=function(e,r){void 0===r&&(r={forcePermission:!1});try{var t=this;return Promise.resolve(v(e,{name:t.appName},r.forcePermission)).then(function(e){t.permission=e})}catch(e){return Promise.reject(e)}},s.reconnect=function(e){return this.connect(e,{forcePermission:!0})},s.getPKH=function(){try{return A(this.permission),Promise.resolve(this.permission.pkh)}catch(e){return Promise.reject(e)}},s.mapTransferParamsToWalletParams=function(e){try{var r=this;return Promise.resolve(e()).then(function(e){var t=r.removeDefaultParams;return Promise.resolve(n(r.formatParameters(e))).then(function(n){return t.call(r,e,n)})})}catch(e){return Promise.reject(e)}},s.mapOriginateParamsToWalletParams=function(e){try{var r=this;return Promise.resolve(e()).then(function(e){var t=r.removeDefaultParams;return Promise.resolve(o(r.formatParameters(e))).then(function(n){return t.call(r,e,n)})})}catch(e){return Promise.reject(e)}},s.mapDelegateParamsToWalletParams=function(e){try{var r=this;return Promise.resolve(e()).then(function(e){var t=r.removeDefaultParams;return Promise.resolve(i(r.formatParameters(e))).then(function(n){return t.call(r,e,n)})})}catch(e){return Promise.reject(e)}},s.sendOperations=function(e){try{return A(this.permission),Promise.resolve(P(this.permission.pkh,e.map(I)))}catch(e){return Promise.reject(e)}},s.sign=function(e){try{return A(this.permission),Promise.resolve(f(this.permission.pkh,e))}catch(e){return Promise.reject(e)}},s.broadcast=function(e){try{return A(this.permission),Promise.resolve(p(e))}catch(e){return Promise.reject(e)}},s.formatParameters=function(e){return e.fee&&(e.fee=e.fee.toString()),e.storageLimit&&(e.storageLimit=e.storageLimit.toString()),e.gasLimit&&(e.gasLimit=e.gasLimit.toString()),e},s.removeDefaultParams=function(e,r){return e.fee||delete r.fee,e.storageLimit||delete r.storage_limit,e.gasLimit||delete r.gas_limit,r},(r=[{key:"connected",get:function(){return Boolean(this.permission)}}])&&function(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}(e.prototype,r),e}();N.isAvailable=d,N.onAvailabilityChange=y,N.getCurrentPermission=h,N.onPermissionChange=E;var L=function(e){function r(){var r;return(r=e.apply(this,arguments)||this).name="TempleWalletNotConnected",r.message="You need to connect TempleWallet by calling templeWallet.connect() first",r}return m(r,e),r}(S);function A(e){if(!e)throw new L}function I(e){var r=e.fee,t=e.gas_limit,n=e.storage_limit,o=l(e,["fee","gas_limit","storage_limit"]);switch(e.kind){case"origination":return c({},o,{mutez:!0,fee:r,gasLimit:t,storageLimit:n});case"transaction":var i=o.destination,s=o.amount,a=o.parameters;return c({},l(o,["destination","amount","parameters"]),{to:i,amount:+s,mutez:!0,parameter:a,fee:r,gasLimit:t,storageLimit:n});default:return c({},o,{fee:r,gasLimit:t,storageLimit:n})}}export{w as InvalidParamsTempleWalletError,L as NotConnectedTempleWalletError,O as NotFoundTempleWalletError,T as NotGrantedTempleWalletError,a as TempleDAppErrorType,s as TempleDAppMessageType,u as TemplePageMessageType,N as TempleWallet,S as TempleWalletError,h as getCurrentPermission,d as isAvailable,y as onAvailabilityChange,E as onPermissionChange,p as requestBroadcast,P as requestOperation,v as requestPermission,f as requestSign};
//# sourceMappingURL=index.module.js.map
